---
title: "Analysis 5"
format:
  html:
    embed-resources: true
project:
  output-dir: results
editor: visual
editor_options: 
  chunk_output_type: console
execute: 
  warning: false
  message: false
---

## Loading packages

```{r}
#| label: load_packages_9

library("tidyverse")
library("broom")
library("patchwork")

source(here::here("R", "99_proj_func.R"))
```

## Loading data files

```{r}
#| label: load_data_9

data_aug <- read_csv(file = here::here("data/data_aug.csv"))
```

## Differences in CD makers on CD4 and CD8 T cells

In the data set, the `CD4 T cells` and `CD8 T cells` exist in two similar and parallel subsets in the `thymus`, `SP1ap` and `SP1am`, and four subsets in the `blood`, `naive`, `central memory` (CM) `effector memory` (EM) and `TEMRA`. It is therefore interesting to investigate differences in CD marker expression between `CD4` and `CD8` T cells for each pair of subset.

## Applying a linear model

To assess significant differences in CD marker expression between each pair, a linear model was applied using the `map()` function as described in analysis 4. In order to compare the CDs for a specific subset between `CD4` and `CD8`, the data must be grouped by the pair, hence why the variable `pair` was added. As the `CD4 T cells` are listed first in the function `cell_type_order`, their estimate corresponds the intercept, while the estimate of the `CD8 T cells` is the slope, corresponding to how much the CD expression differs from the `CD4 T cells`. Lastly, the full estimates were calculated by adding the intercept to the estimate of the `CD8 T cells`, and the variable `is_significant` and `any_significant` is added from the calculated p-value. The step `filter(n() > n_distinct(cell_type))` is added to ensure more than one observation for each `cell_type` in each `pair`.

```{r}
#| label: apply_lm_9

columns <- c("tissue", 
             "CD",
             "cell_type",
             "pair",
             "estimate", 
             "conf.low", 
             "conf.high",
             "p.value",
             "is_significant",
             "any_significant")

data_analysis5  <- data_aug |>
  filter(str_detect(cell_type, "CD4") | str_detect(cell_type, "CD8"),
         cell_type != "CD4ISP",
         cell_type != "TCD8RAdim",
         hierarchy == 4) |>
  select(-c("CVQb", "PEpos")) |>
  drop_na(MedQb) |>
  mutate(pair = case_when(str_detect(cell_type, "SP1ap") ~ "SP1ap",
                          str_detect(cell_type, "SP1am") ~ "SP1am",
                          str_ends(cell_type, "naive") ~ "naive",
                          str_ends(cell_type, "CM") ~ "CM",
                          str_ends(cell_type, "EM") ~ "EM",
                          str_detect(cell_type, "TEMRA") ~ "TEMRA"),
         .before = cell_type) |>
  group_by(tissue, CD, pair) |>
  filter(n() > n_distinct(cell_type)) |>
  fit_linear_model(log(MedQb) ~ cell_type)|>
  mutate(is_significant = case_when(term == "(Intercept)" ~ "reference",
                                    p.value < 0.05 ~ "yes",
                                    p.value >= 0.05 ~ "no"),
          any_significant = case_when(any(is_significant == "yes") ~ "yes",
                                     .default = "no")) |>
  mutate(
    intercept = estimate[term == "(Intercept)"],
    estimate = case_when(
      term == "(Intercept)" ~ estimate,
      term != "(Intercept)" ~ estimate + intercept),
    conf.low = case_when(
      term == "(Intercept)" ~ conf.low,
      term != "(Intercept)" ~ conf.low + intercept),
    conf.high = case_when(
      term == "(Intercept)" ~ conf.high,
      term != "(Intercept)" ~ conf.high + intercept),
    cell_type = case_when(
      term == "(Intercept)" & pair == "SP1ap" ~ "CD4SP1ap",
      term == "(Intercept)" & pair == "SP1am" ~ "CD4SP1am",
      term == "(Intercept)" & pair == "naive" ~ "TCD4naive",
      term == "(Intercept)" & pair == "CM" ~ "TCD4CM",
      term == "(Intercept)" & pair == "EM" ~ "TCD4EM", 
      term == "(Intercept)" & pair == "TEMRA" ~ "TCD4TEMRA",
      .default = str_remove(term, "cell_type"))) |>
  select(all_of(columns)) |>
  ungroup() |>
  filter(any_significant == "yes") |>
  mutate(lineage = case_when(str_detect(cell_type, "CD4") ~ "CD4 T cells",
                             .default = "CD8 T cells"),
         .before = cell_type)

```

## Count of significant CDs

Below are the number of significant CDs for each pair calculated and visualized.

```{r}
#| label: count_sig_CDs_9

sig_CD_count <- data_analysis5 |>
  plot_sig_CDs(by_variable = pair, 
                 fill_color = "hotpink")


sig_CD_count
```

## Visualization of significant CDs between each pair

The significant CDs for each pair are visualized with an error bar plot of the estimate and the confidence intervals by using the function `plot_CD4vsCD8()`. The six figures are plotted together by using the package `patchwork`.

```{r}
#| label: create_plots_9
#| fig-height: 10
#| fig-width: 8

p1 <- data_analysis5 |>
  CD_order() |>
  plot_CD4vsCD8(pair = "SP1ap",
                legend_position = "none")

p2 <- data_analysis5 |>
  CD_order() |>
  plot_CD4vsCD8(pair = "SP1am",
                legend_position = "none")

p3 <- data_analysis5 |>
  CD_order() |>
  plot_CD4vsCD8(pair = "naive",
                legend_position = "none")

p4 <- data_analysis5 |>
  CD_order() |>
  plot_CD4vsCD8(pair = "CM",
                legend_position = "none")

p5 <- data_analysis5 |>
  CD_order() |>
  plot_CD4vsCD8(pair = "EM",
                legend_position = "none")

p6 <- data_analysis5 |>
  CD_order() |>
  plot_CD4vsCD8(pair = "TEMRA",
                legend_position = "bottom")

(p1 + p2) / (p3 + p4) / (p5 + p6) +
  plot_annotation(
    title = "Significant CD Markers Differentiating CD4 and CD8 T Cell Subsets") &
  theme(plot.title = element_text(size = 18))
```

## Plot export

As the figure above is too big for the presentation only the plot for the naive T cells is saved.

```{r}
#| label: export_plots_9

p3 <- data_analysis5 |>
  CD_order() |>
  plot_CD4vsCD8(pair = "naive",
                legend_position = "bottom")

final_plot <- sig_CD_count / p3

save_plot(plot = final_plot,
          filename = "09_key_plot.png",
          width = 7,
          height = 9)
```
