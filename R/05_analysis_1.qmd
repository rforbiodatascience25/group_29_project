---
title: "05_PCA"
format:
  html:
    embed-resources: true
project:
  output-dir: results
editor: visual
editor_options: 
  chunk_output_type: console
execute: 
  warning: false
  message: false
---

## Loading packages

```{r}
#| label: load_packages_5

library("tidyverse")
library("broom")
library("ggrepel")
library("patchwork")

source(file = here::here("R/99_proj_func.R"))
```

## Loading data files

```{r}
#| label: load_data_5

PCA_aug <- read_csv(file = here::here("data/PCA_aug.csv"))

```

## Make the PCA fit

After all numeric cells were populated the function `prcomp` was used to make the the PCA.

```{r}
#| label: create_PCA_fit_5

PCA_fit <- PCA_aug |> 
  select(where(is.numeric)) |>
  prcomp(scale = TRUE)

```

## Make the plot

On the plot we have PC1 on the x-axis and PC2 on the y-axis. Usually most variation can be captured with the first two principal components. The points are stratified using tissue type (blood, tonsil, thymus) as the shapes and cell lineage as the color.

```{r}
#| label: create_scatterplot_5

scatter_plot <- PCA_fit |> 
  augment(data = PCA_aug) |>
  ggplot(aes(.fittedPC1, 
             .fittedPC2,
             shape = tissue,
             color = lineage)) +
  geom_point(size = 3,
             alpha = 0.8) +
  labs(title = "PCA plot stratified on tissue and lineage",
       x = "PC1",
       y = "PC2",
       color = "Lineage") +
  scale_color_brewer(palette = "Set1") +
  theme_bw(base_size = 13) +
    theme(legend.key.size = unit(0.4, "lines"),
          legend.text = element_text(size = 7),
          legend.spacing.y = unit(0.1, "lines"),
          legend.spacing.x = unit(0.2, "lines"))
 
scatter_plot
```

As we can see on the plot we have some nice clustering. We see all the cells from thymus clustered nicely and tonsil cells are also somewhat clustered. In the blood we see two different clusters, with one containing all blood B cells except for one, and the other one containing the rest of the cell lineages. We can also see that the B cell lineage from blood and thymus didn't vary much in PC1 but PC2 set them apart.

## Rotation matrices

**Rotation matrix - all variables:**

```{r}
#| label: create_rotplot1_5

PCA_fit |> 
  PCA_rotation(prefix = ".*",
               amount = Inf,
               xlimits = c(-0.15, 0.15),
               ylimits = c(-0.15, 0.15),
               subtitle   = "Rotation matrix for all variables")

```

As the plot of the rotation matrix is very cluttered, the variables are separated into `MedQb` and `PRpos`.

**MedQb - all variables:**

```{r}
#| label: create_rotplot2_5

PCA_fit |> 
  PCA_rotation(prefix = "MedQb_",
               amount = Inf,
               xlimits = c(-0.15, 0.15),
               ylimits = c(-0.15, 0.15),
               subtitle   = "Rotation matrix for all MedQb variables")

```

**MedQb - top 10 variables:**

```{r}
#| label: create_rotplot3_5

MedQb_top10 <- PCA_fit |>
  PCA_rotation(prefix = "MedQb_",
               amount = 10,
               xlimits = c(-0.15, 0.15),
               ylimits = c(-0.15, 0.15),
               subtitle   = "MedQb")

MedQb_top10
```

**PEpos - all variables:**

```{r}
#| label: create_rotplot4_5

PCA_fit |>
  PCA_rotation(prefix = "PEpos_",
               amount = Inf,
               xlimits = c(-0.15, 0.15),
               ylimits = c(-0.15, 0.15),
               subtitle = "Rotation matrix for all PEpos variables")

```

**PEpos - top 10 variables:**

```{r}
#| label: create_rotplot5_5

PEpos_top10 <- PCA_fit |>
  PCA_rotation(prefix = "PEpos_",
               amount = 10,
               xlimits = c(-0.15, 0.15),
               ylimits = c(-0.15, 0.15),
               subtitle = "PEpos")

PEpos_top10
```

## Plot export

```{r}
#| label: export_plots_5

MedQb_top10 <- MedQb_top10 +
    labs(title = "Rotation matrix for top 10 longest vectors")
  
rota_plot <- (MedQb_top10 + PEpos_top10)

final_plot <- scatter_plot / rota_plot

save_plot(plot = final_plot,
          filename = "05_key_plot.png",
          width = 8,
          height = 9)
```
