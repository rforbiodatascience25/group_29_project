---
title: "05_PCA"
format: html
editor_options: 
  chunk_output_type: console
---

# Loading libraries

```{r}

library("tidyverse")
library("broom")

```

# Loading data files

```{r}

PCA_aug <- read_csv(file = "data/PCA_aug.csv")

```

# Make the PCA set

After all numeric cells were populated the function `prcomp` was used to make the the PCA.

```{r}

PCA_data <- PCA_aug |> 
  select(where(is.numeric)) |>
  prcomp(scale = TRUE)

```

# Make the plot

On the plot we have PC1 on the x-axis and PC2 on the y-axis. Usually most variation can be captured with the first two principal components. The points are stratified using tissue type (blood, tonsil, thymus) as the shapes and cell lineage as the color.

```{r}

PCA_data |> 
  augment(data = PCA_aug) |>
  ggplot(aes(.fittedPC1, 
             .fittedPC2,
             shape = tissue,
             color = lineage)) +
  geom_point(size = 1.5,
             alpha = 0.4) +
  labs(title = "PCA plot",
       x = "PC1",
       y = "PC2",
       color = "cell lineage") +
  theme_bw()+
    theme(
      legend.key.size = unit(0.4, "lines"),
      legend.text = element_text(size = 7),
      legend.spacing.y = unit(0.1, "lines"),
      legend.spacing.x = unit(0.2, "lines")
  )

```

### Plot interpretation

As we can see on the plot we have some nice clustering. We see all the cells from thymus clustered nicely and tonsil cells are also somewhat clustered. In the blood we see two different clusters, with one containing all blood B cells except for one, and the other one containing the rest of the cell lineages. We can also see that the B cell lineage from blood and thymus didn't vary much in PC1 but PC2 set them apart.

# Rotation matrix full

### with PEpos

```{r}
library(ggrepel)
library(dplyr)
library(stringr)

arrow_style <- arrow(angle = 30, 
                     ends = "first", 
                     type = "closed", 
                     length = grid::unit(5, "pt"))

PCA_data |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", 
              names_prefix = "PC", 
              values_from = "value") |>
  
  # keep only PEpos variables
  filter(str_starts(column, "PEpos")) |>
  
  mutate(arrow_length = sqrt(PC1^2 + PC2^2)) |>
  filter(arrow_length > 0.1) |>
  
  ggplot(aes(PC1, PC2)) +
  geom_segment(
    aes(xend = 0, yend = 0),
    arrow = arrow_style
  ) +
  geom_text_repel(
    aes(label = column),
    size = 3,
    color = "hotpink",
    min.segment.length = 0,
    direction = "both",
    max.overlaps = Inf
  ) +
  xlim(-0.12, 0.13) +
  ylim(-0.11, 0.15) +
  coord_fixed(ratio = 1) +
  theme_minimal(base_size = 16)


```

### With MedQb

```{r}
library(ggrepel)
library(dplyr)
library(stringr)

arrow_style <- arrow(angle = 30, 
                     ends = "first", 
                     type = "closed", 
                     length = grid::unit(5, "pt"))

PCA_data|>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", 
              names_prefix = "PC", 
              values_from = "value") |>
  
  # keep only MedQb variables
  filter(str_starts(column, "MedQb")) |>
  
  mutate(arrow_length = sqrt(PC1^2 + PC2^2)) |>
  filter(arrow_length > 0.01) |>
  
  ggplot(aes(PC1, PC2))+
  geom_segment(
    aes(xend = 0, yend = 0),
    arrow = arrow_style
  ) +
  geom_text_repel(
    aes(label = str_remove(column, "MedQb_")),
    size = 3,
    color = "hotpink",
    min.segment.length = 0,
    direction = "both",
    max.overlaps = Inf
  ) +
  xlim(-0.12, 0.13) +
  ylim(-0.11, 0.15) +
  coord_fixed(ratio = 1) +
  theme_minimal(base_size = 16)
```

## Maybe try something like this to filter the vectors

```{r}

#top_vars <- rotation_df %>%
  #mutate(contrib = abs(PC1) + abs(PC2)) %>% 
  #slice_max(contrib, n = 10)
```

# Rotation matrix top 10 values

### With PEpos

```{r}
#Make set
PCA_pepos <- PCA_data |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", 
              names_prefix = "PC", 
              values_from = "value")

#Top values
top_vars <- PCA_pepos %>%
  filter(str_starts(column, "PEpos")) |>
  mutate(contrib = abs(PC1) + abs(PC2)) %>% 
  slice_max(contrib, n = 10)

arrow_style <- arrow(angle = 30, 
                     ends = "first", 
                     type = "closed", 
                     length = grid::unit(5, "pt"))

top_vars |>
  mutate(arrow_length = sqrt(PC1^2 + PC2^2)) |>
  filter(arrow_length > 0.1) |>
  
  ggplot(aes(PC1, PC2)) +
  geom_segment(
    aes(xend = 0, yend = 0),
    arrow = arrow_style
  ) +
  geom_text_repel(
    aes(label = str_remove(column, "PEpos_")),
    size = 3,
    color = "hotpink",
    min.segment.length = 0,
    direction = "both",
    max.overlaps = Inf
  ) +
  xlim(-0.12, 0.13) +
  ylim(-0.11, 0.15) +
  coord_fixed(ratio = 1) +
  theme_minimal(base_size = 16)+
  labs(title = "Rotation matrix top 10 values MedQb")
```

### With MedQb

```{r}
#Make set
PCA_medqb <- PCA_data |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", 
              names_prefix = "PC", 
              values_from = "value")

#Top values
top_vars <- PCA_medqb %>%
  filter(str_starts(column, "MedQb")) |>
  mutate(contrib = abs(PC1) + abs(PC2)) %>% 
  slice_max(contrib, n = 10)

arrow_style <- arrow(angle = 30, 
                     ends = "first", 
                     type = "closed", 
                     length = grid::unit(5, "pt"))

top_vars |>
  mutate(arrow_length = sqrt(PC1^2 + PC2^2)) |>
  filter(arrow_length > 0.1) |>
  
  ggplot(aes(PC1, PC2)) +
  geom_segment(
    aes(xend = 0, yend = 0),
    arrow = arrow_style
  ) +
  geom_text_repel(
    aes(label = str_remove(column, "MedQb_")),
    size = 3,
    color = "hotpink",
    min.segment.length = 0,
    direction = "both",
    max.overlaps = Inf
  ) +
  xlim(-0.12, 0.13) +
  ylim(-0.11, 0.15) +
  coord_fixed(ratio = 1) +
  theme_minimal(base_size = 16)+
  labs(title = "Rotation matrix top 10 values MedQb")



```

```{r}

library(ggrepel)
library(dplyr)
library(stringr)
library(broom)      # for tidy()
library(tidyr)      # for pivot_wider
library(ggplot2)

source(file = "R/99_proj_func.R")

PCA_rotation(PCA_test, "MedQb_", 10, 0.01, c(-0.12, 0.13), c(-0.11, 0.15), "test")
```
