---
title: "05_PCA"
format: html
editor_options: 
  chunk_output_type: console
---

# Loading libraries

```{r}
library(tidyverse)
library(broom)
library(ggrepel)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
```

# Loading data files

```{r}

PCA_aug <- read_csv(file = "data/PCA_aug.csv")

```

# Make the PCA set

After all numeric cells were populated the function `prcomp` was used to make the the PCA.

```{r}

PCA_data <- PCA_aug |> 
  select(where(is.numeric)) |>
  prcomp(scale = TRUE)

```

# Make the plot

On the plot we have PC1 on the x-axis and PC2 on the y-axis. Usually most variation can be captured with the first two principal components. The points are stratified using tissue type (blood, tonsil, thymus) as the shapes and cell lineage as the color.

```{r}

PCA_data |> 
  augment(data = PCA_aug) |>
  ggplot(aes(.fittedPC1, 
             .fittedPC2,
             shape = tissue,
             color = lineage)) +
  geom_point(size = 1.5,
             alpha = 0.4) +
  labs(title = "PCA plot",
       x = "PC1",
       y = "PC2",
       color = "cell lineage") +
  theme_bw()+
    theme(
      legend.key.size = unit(0.4, "lines"),
      legend.text = element_text(size = 7),
      legend.spacing.y = unit(0.1, "lines"),
      legend.spacing.x = unit(0.2, "lines")
  )

```

### Plot interpretation

As we can see on the plot we have some nice clustering. We see all the cells from thymus clustered nicely and tonsil cells are also somewhat clustered. In the blood we see two different clusters, with one containing all blood B cells except for one, and the other one containing the rest of the cell lineages. We can also see that the B cell lineage from blood and thymus didn't vary much in PC1 but PC2 set them apart.

# Rotation matrices

Rotation matrix all values

```{r}
source(file = "R/99_proj_func.R")

PCA_rotation(
  data   = PCA_data,
  prefix = ".*",
  amount = Inf,
  xlimits = c(-0.12, 0.13),
  ylimits = c(-0.11, 0.15),
  title   = "Rotation matrix all values"
)
```

PEpos all values

```{r}
source(file = "R/99_proj_func.R")

PCA_rotation(
  data   = PCA_data,
  prefix = "PEpos_",
  amount = Inf,
  xlimits = c(-0.12, 0.13),
  ylimits = c(-0.11, 0.15),
  title   = "Rotation matrix all values PEpos"
)
```

PEpos top 10 values

```{r}
source(file = "R/99_proj_func.R")

PCA_rotation(
  data   = PCA_data,
  prefix = "MedQb_",
  amount = 10,
  xlimits = c(-0.12, 0.13),
  ylimits = c(-0.11, 0.15),
  title   = "Rotation matrix top 10 values PEpos"
)
```

MedQb all values

```{r}
source(file = "R/99_proj_func.R")

PCA_rotation(
  data   = PCA_data,
  prefix = "MedQb_",
  amount = Inf,
  xlimits = c(-0.12, 0.13),
  ylimits = c(-0.11, 0.15),
  title   = "Rotation matrix all values MedQb"
)
```

MedQb top 10 values

```{r}

source(file = "R/99_proj_func.R")

PCA_rotation(
  data   = PCA_data,
  prefix = "MedQb_",
  amount = 10,
  xlimits = c(-0.12, 0.13),
  ylimits = c(-0.11, 0.15),
  title   = "Rotation matrix top 10 values MedQb"
)

```
