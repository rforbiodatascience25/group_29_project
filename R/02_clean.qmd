---
title: "Cleaning data"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

# Loading packages

```{r}

library("tidyverse")

source(file = "R/99_proj_func.R")
```

# Loading data files

```{r}

blood <- read_csv(file = "data/blood_load.csv")

tonsil <- read_csv(file = "data/tonsil_load.csv")

thymus <- read_csv(file = "data/thymus_load.csv")
```

# Cleaning each data set

Each dataset is standardized using the function pivot_selected_variables(), which reshapes wide data into a tidy long format. It extracts only the selected variables (CVQb, MedQb, count, PEpos), splits the variable names into cell_type and measurement columns, and tags each observation with its tissue. This ensures that all datasets share the same column structure and can be merged later without conflicts.

```{r}

selected_measures <- c("CVQb", "MedQb", "PEpos")

blood_clean <- blood |> 
  pivot_selected_variables(ID_col = "CD",
                           variables = selected_measures,
                           tissue = "blood")
                            

tonsil_clean <- tonsil |> 
  pivot_selected_variables(ID_col = "CD",
                           variables = selected_measures,
                           tissue = "tonsil")

thymus_clean <- thymus |> 
  pivot_selected_variables(ID_col = "CD",
                           variables = selected_measures,
                           tissue = "thymus")
```

# Merge the three cleaned data sets

Here the cleaned datasets from blood, tonsil, and thymus are combined into one large table (data_clean) using bind_rows(). Control samples labeled “FMO” are filtered out since they are used only for calibration. The result is a clean, uniform dataset containing all immune-cell measurements, ready for further analysis.

```{r}

data_clean <- bind_rows(blood_clean,
                        tonsil_clean,
                        thymus_clean) |>
  filter(CD != "FMO")
```

# Preparing data set for PCA

### Populating all cells in dataset

When you make a PCA plot you need all numeric rows and columns to be filled with data. So firstly we needed to fill the empty cells with data. These were empty due to the different cell types and CD's. Unpopulated cells was populated with the median for the column. We avoided using the mean due to outliers potentially skewing the data.

```{r}
PCA_clean <- data_clean |>
  pivot_wider(id_cols = c("tissue", "cell_type"),
              names_from = "CD",
              values_from = c("MedQb", "PEpos"),
              values_fn = mean) |>
  mutate(across(
    where(is.numeric),
    ~ if_else(is.na(.x), 
              median(.x, 
                     na.rm = TRUE), .x)
  ))
  
```

# Writing data files

```{r}

write_csv(x = data_clean,
          file = "data/data_clean.csv")

write_csv(x = PCA_clean,
          file = "data/PCA_clean.csv")
```
