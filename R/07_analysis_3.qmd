---
title: "Analysis 3"
format:
  html:
    embed-resources: true
editor: visual
---

# Loading packages

```{r}
#| label: load_packages
#| message: false
#| warning: false

library("tidyverse")
library("scales")
library("patchwork")
library("broom")

source(here::here("R", "99_proj_func.R"))
```

# Loading data files

```{r}
#| label: load_data
#| message: false
#| warning: false

data_aug <- read_csv(here::here("data", "data_aug.csv"))

```

# Analysis of Fluorescence Variation Across Immune Cell Types and Tissues

The purpose of these plots is to examine and compare the fluorescence signals across key immune cell types and tissues. By displaying both the median fluorescence (MedQb) and the coefficient of variation (CVQb) for the selected cells, we can see both the signal strength and signal stability for the different CD markers.

We use the four cell types B cells from tonsil and blood, CD4 and CD8 T cells from blood, and thymocytes from the thymus for biologically different environments in the immune system. By visualizing, we can see how fluorescence levels vary between mature and immature cellshow signal variation depends on tissue type whether the expression of CD markers is stable or heterogeneous within a given location and which cell types show the most or least variation in the CD marker profiles and see patterns and features in the biology.

# Flourescence of B cells

```{r}
#| label: B_cells_blood
#| message: false
#| warning: false
#| fig-height: 10
#| fig-width: 9

data_aug |>
  asc_CDs_boxplot(lineage = "B cells",
                  hierarchy_level = 3,
                  tissue = "blood",
                  measure = MedQb)

data_aug |>
  asc_CDs_boxplot(lineage = "B cells",
                  hierarchy_level = 3,
                  tissue = "blood",
                  measure = CVQb)

data_aug |>
    asc_CDs_boxplot(lineage = "B cells",
                  hierarchy_level = 3,
                  tissue = "blood",
                  measure = PEpos)

p1 / p2 / p3
```

From the plots, it looks like that there might be a correlation between the three variables. When the `MedQb` increases, the `CVQb` seems to decrease. For `PEpos` the correlation does not seem as strong, but it may increase, when `MedQb` increases.

# Applying a linear model

In the next part, this is assessed by creating a linear model of the two variables, `CVQb` and `PEpos`, against `MedQb`. Additionally, the correlation coefficients are calculated.

```{r}

columns <- c("tissue",
             "lineage",
             "term_CVQb",
             "estimate_CVQb",
             "term_PEpos",
             "estimate_PEpos")

data_lm <- data_aug |>
  filter(lineage != "T cells",
         !hierarchy_level %in% c(1, 2)) |>
  group_by(tissue, lineage) |>
  nest() |>
  mutate(model_object_CVQb = map(.x = data,
                   .f = ~lm(formula = log(MedQb) ~ log(CVQb),
                            data = .x)),
         model_object_PEpos = map(.x = data,
                   .f = ~lm(formula = log(MedQb) ~ log(PEpos),
                            data = .x))) |>
  mutate(model_object_tidy_CVQb = map(.x = model_object_CVQb,
                                 .f = ~tidy(.x, 
                                           conf.int = TRUE,
                                           conf.level = 0.95)),
         model_object_tidy_PEpos = map(.x = model_object_PEpos,
                                 .f = ~tidy(.x, 
                                           conf.int = TRUE,
                                           conf.level = 0.95))) |>
  unnest(model_object_tidy_CVQb,
         model_object_tidy_PEpos) |>
  rename(term_CVQb = "term",
         term_PEpos = "term1",
         estimate_CVQb = "estimate",
         estimate_PEpos = "estimate1") |>
  select(columns) |>
  ungroup() |>
  mutate(
    term_CVQb = case_when(
      term_CVQb == "(Intercept)" ~ "intercept",
      term_CVQb != "(Intercept)" ~ "slope"),
    term_PEpos = case_when(
      term_PEpos == "(Intercept)" ~ "intercept",
      term_PEpos != "(Intercept)" ~ "slope")) |>
  pivot_longer(cols = c(term_CVQb, term_PEpos, estimate_CVQb, estimate_PEpos),
                        names_to = c(".value", "measure"),
                        names_pattern = "(.*)_(.*)") |>
  mutate(measure = str_remove(measure, "term_")) |>
  pivot_wider(id_cols = c("tissue", "lineage"),
              names_from = c("measure", "term"),
              values_from = estimate)



```

The correlation coefficient is now calculated.

```{r}

data_params <- data_aug |>
  filter(!is.na(MedQb), 
         !is.na(CVQb), 
         !is.na(PEpos),
         lineage != "T cells",
         !hierarchy_level %in% c(1, 2)) |>
  group_by(tissue, lineage) |>
  summarise(CVQb_cor = cor(log(CVQb), log(MedQb)),
            PEpos_cor = cor(log(PEpos), log(MedQb))) |>
  left_join(y = data_lm,
            by = c("tissue", "lineage"),
            relationship = "one-to-one")
```

In the last, scatter plots with the linear model are created.

For CVQb:

```{r}

CVQb_intercept <- data_params |> 
    filter(lineage == "B cells",
           tissue == "blood") |>
  pull(CVQb_intercept)


CVQb_slope <- data_params |> 
    filter(lineage == "B cells",
           tissue == "blood") |>
  pull(CVQb_slope)

CVQb_cor <- data_params |> 
    filter(lineage == "B cells",
           tissue == "blood") |>
  pull(CVQb_cor)
  
p1 <- data_aug |>
  filter(lineage == "B cells",
         tissue == "blood") |>
  ggplot(aes(x = log(CVQb),
             y = log(MedQb))) +
  geom_point(color = "grey",
             alpha = 0.5) +
  geom_smooth(method = "lm",
              color = "blue") +
  theme_bw() + 
  labs(title = "something",
       subtitle = paste0("y = ", round(CVQb_intercept, 2), 
                         " ", 
                         round(CVQb_slope, 2), 
                         " * x, correlation coefficient = ", 
                         round(CVQb_cor, 2)))
```

For PEpos:

```{r}

PEpos_intercept <- data_params |> 
    filter(lineage == "B cells",
           tissue == "blood") |>
  pull(PEpos_intercept)


PEpos_slope <- data_params |> 
    filter(lineage == "B cells",
           tissue == "blood") |>
  pull(PEpos_slope)

PEpos_cor <- data_params |> 
    filter(lineage == "B cells",
           tissue == "blood") |>
  pull(PEpos_cor)
  
p2 <- data_aug |>
  filter(lineage == "B cells",
         tissue == "blood") |>
  ggplot(aes(x = log(PEpos),
             y = log(MedQb))) +
  geom_point(color = "grey",
             alpha = 0.5) +
  geom_smooth(method = "lm",
              color = "hotpink") +
  theme_bw() + 
  labs(title = "something",
       subtitle = paste0("y = ", round(PEpos_intercept, 2), 
                         " + ", 
                         round(PEpos_slope, 2), 
                         " * x, correlation coefficient = ", 
                         round(PEpos_cor, 2)))


p1 + p2
```
