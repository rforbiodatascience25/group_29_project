---
title: "Analysis 3"
format:
  html:
    embed-resources: true
editor: visual
---

# Loading packages

```{r}
#| label: load_packages
#| message: false
#| warning: false

library(tidyverse)
library(scales)
library(patchwork)

source(here::here("R", "99_proj_func.R"))
```

# Loading data files

```{r}
#| label: load_data
#| message: false
#| warning: false

data_aug <- read_csv(here::here("data", "data_aug.csv"))

```

#Analysis of Fluorescence Variation Across Immune Cell Types and Tissues

The purpose of these plots is to examine and compare the fluorescence signals across key immune cell types and tissues. By displaying both the median fluorescence (MedQb) and the coefficient of variation (CVQb) for the selected cells, we can see both the signal strength and signal stability for the different CD markers.

We use the four cell types B cells from tonsil and blood, CD4 and CD8 T cells from blood, and thymocytes from the thymus for biologically different environments in the immune system. By visualizing, we can see how fluorescence levels vary between mature and immature cellshow signal variation depends on tissue type whether the expression of CD markers is stable or heterogeneous within a given location and which cell types show the most or least variation in the CD marker profiles and see patterns and features in the biology.

# Flourescence of B cells

```{r}
#| label: B_cells_blood
#| message: false
#| warning: false
#| fig-height: 10
#| fig-width: 9

p1 <- data_aug |>
  asc_CDs_boxplot(lineage = "B cells",
                  hierarchy_level = 3,
                  tissue = "blood",
                  measure = MedQb)

p2 <- data_aug |>
  asc_CDs_boxplot(lineage = "B cells",
                  hierarchy_level = 3,
                  tissue = "blood",
                  measure = CVQb)

data_aug |>
  filter(lineage == "B cells",
         tissue == "blood") |>
  ggplot(aes(x = log(CVQb),
             y = log(MedQb))) +
  geom_point(color = "hotpink",
             alpha = 0.5) +
  geom_smooth(method = "lm",
              color = "navy",
              se = FALSE) +
  theme_bw()

p1 / p2 / p3
```

```{r}
data_aug |>
  filter(tissue == "blood",
         lineage == "B cells",
         !is.na(CVQb),
         !is.na(MedQb)) |>
  summarise(cor = cor(log(CVQb), log(MedQb)))

```

In boxplots for B cells in blood exhibit a more uniform and stable fluorescence pattern, which is also expected since blood primarily contains mature and less varied B cell populations.

```{r}
#| label: B_cells_tonsil
#| message: false
#| warning: false
#| fig-height: 10
#| fig-width: 9

p1 <- data_aug |>
  asc_CDs_boxplot(lineage = "B cells",
                  hierarchy_level = 3,
                  tissue = "tonsil",
                  measure = MedQb)

p2 <- data_aug |>
  asc_CDs_boxplot(lineage = "B cells",
                  hierarchy_level = 3,
                  tissue = "tonsil",
                  measure = CVQb)

data_aug |>
  filter(lineage == "B cells",
         tissue == "tonsil") |>
  ggplot(aes(x = log(CVQb),
             y = log(MedQb))) +
  geom_point(color = "hotpink",
             alpha = 0.5) +
  geom_smooth(method = "lm",
              color = "navy",
              se = FALSE) +
  theme_bw()

p1 / p2 / p3


```

```{r}
data_aug |>
  filter(tissue == "tonsil",
         lineage == "B cells",
         !is.na(CVQb),
         !is.na(MedQb)) |>
  summarise(cor = cor(log(CVQb), log(MedQb)))
```

```{r}


```

Boxplots for B cells from the tonsil show both high and varying levels of fluorescence. This biologically makes sense as the tonsil contains many different maturation stages of B cells, which can be seen specifically in the plots as increased variation in MedQb and CVQb.

# Flourescence of T cells

```{r}
#| label: CD4_T_cells
#| message: false
#| warning: false
#| fig-height: 12
#| fig-width: 9

p1 <- data_aug |>
  asc_CDs_boxplot(lineage = "CD4 T cells",
                  hierarchy_level = 4,
                  tissue = "blood",
                  measure = MedQb)

p2 <- data_aug |>
  asc_CDs_boxplot(lineage = "CD4 T cells",
                  hierarchy_level = 4,
                  tissue = "blood",
                  measure = CVQb)
p3 <-data_clean |>
  filter(lineage == "CD4 T cells",
         tissue == "blood") |>
  ggplot(aes(x = CVQb,
             y = MedQb)) +
  geom_point(color = "hotpink",
             alpha = 0.5) +
  scale_x_log10() +
  scale_y_log10()

p1 / p2 / p3
```

CD4 T cells in the blood are predominantly mature, and therefore their fluorescence levels are close. They express a stable set of CD markers, which is reflected in predominantly high MedQb values ​​and low variation in CVQb. This is because the blood primarily contains mature, naive or memory CD4 cells.

```{r}
#| label: CD8_T_cells
#| message: false
#| warning: false
#| fig-height: 10
#| fig-width: 9

p1 <- data_aug |>
  asc_CDs_boxplot(lineage = "CD8 T cells",
                  hierarchy_level = 4,
                  tissue  = "blood",
                  measure = MedQb)

p2 <- data_aug |>
  asc_CDs_boxplot(lineage = "CD8 T cells",
                  hierarchy_level = 4,
                  tissue = "blood",
                  measure = CVQb)

p3 <-data_clean |>
  filter(lineage == "CD8 T cells",
         tissue == "blood") |>
  ggplot(aes(x = CVQb,
             y = MedQb)) +
  geom_point(color = "hotpink",
             alpha = 0.5) +
  scale_x_log10() +
  scale_y_log10()

p1 / p2 / p3
```

CD4 T cells show relatively homogeneous fluorescence with stable signal levels. However, a low level of variation is seen, consistent with the fact that CD4 cells in blood are typically mature and functionally show a more stable signal.

```{r}
#| label: Thymocytes
#| message: false
#| warning: false
#| fig-height: 10
#| fig-width: 9

p1 <- data_aug |>
  asc_CDs_boxplot(lineage = "thymocytes",
                  hierarchy_level = 4,
                  tissue = "thymus",
                  measure = MedQb)

p2 <- data_aug |>
  asc_CDs_boxplot(lineage = "thymocytes",
                  hierarchy_level = 4,
                  tissue = "thymus",
                  measure = CVQb)
p3 <-data_clean |>
  filter(lineage == "thymocytes",
         tissue == "thymus") |>
  ggplot(aes(x = CVQb,
             y = MedQb)) +
  geom_point(color = "hotpink",
             alpha = 0.5) +
  scale_x_log10() +
  scale_y_log10()

p1 / p2 / p3
```

Thymocytes show more variable fluorescence signals across markers, which fits well with the biological heterogeneity in the thymus, where T cells are in many different stages of development.
